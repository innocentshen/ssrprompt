generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Provider {
  id        String       @id @default(uuid())
  userId    String       @default("default") @map("user_id")
  name      String
  type      ProviderType
  apiKey    String       @map("api_key_encrypted")
  baseUrl   String?      @map("base_url")
  enabled   Boolean      @default(false)
  isSystem  Boolean      @default(false) @map("is_system")
  createdAt DateTime     @default(now()) @map("created_at")
  updatedAt DateTime     @updatedAt @map("updated_at")
  models    Model[]
  user      User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isSystem])
  @@map("providers")
}

model Model {
  id                      String       @id @default(uuid())
  providerId              String       @map("provider_id")
  modelId                 String       @map("model_id")
  name                    String
  capabilities            Json         @default("[]")
  maxContextLength        Int          @default(8000) @map("max_context_length")
  supportsVision          Boolean      @default(false) @map("supports_vision")
  supportsReasoning       Boolean      @default(false) @map("supports_reasoning")
  supportsFunctionCalling Boolean      @default(false) @map("supports_function_calling")
  createdAt               DateTime     @default(now()) @map("created_at")
  judgeEvals              Evaluation[] @relation("JudgeModel")
  evaluations             Evaluation[] @relation("EvaluationModel")
  provider                Provider     @relation(fields: [providerId], references: [id], onDelete: Cascade)
  prompts                 Prompt[]     @relation("DefaultModel")
  traces                  Trace[]

  @@index([providerId])
  @@map("models")
}

model Prompt {
  id             String          @id @default(uuid())
  userId         String          @default("default") @map("user_id")
  name           String
  description    String?
  content        String?
  variables      Json            @default("[]")
  messages       Json            @default("[]")
  config         Json            @default("{}")
  currentVersion Int             @default(1) @map("current_version")
  defaultModelId String?         @map("default_model_id")
  groupId        String?         @map("group_id")
  orderIndex     Int             @default(0) @map("order_index")
  createdAt      DateTime        @default(now()) @map("created_at")
  updatedAt      DateTime        @updatedAt @map("updated_at")
  isPublic      Boolean         @default(false) @map("is_public")
  evaluations    Evaluation[]
  versions       PromptVersion[]
  defaultModel   Model?          @relation("DefaultModel", fields: [defaultModelId], references: [id])
  group          PromptGroup?    @relation(fields: [groupId], references: [id], onDelete: SetNull)
  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  traces         Trace[]

  @@index([userId])
  @@index([groupId])
  @@index([orderIndex])
  @@map("prompts")
}

model PromptGroup {
  id         String        @id @default(uuid())
  userId     String        @default("default") @map("user_id")
  name       String
  parentId   String?       @map("parent_id")
  orderIndex Int           @default(0) @map("order_index")
  createdAt  DateTime      @default(now()) @map("created_at")
  updatedAt  DateTime      @updatedAt @map("updated_at")
  user       User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  parent     PromptGroup?  @relation("PromptGroupHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children   PromptGroup[] @relation("PromptGroupHierarchy")
  prompts    Prompt[]

  @@index([userId])
  @@index([parentId])
  @@index([orderIndex])
  @@map("prompt_groups")
}

model PromptVersion {
  id             String    @id @default(uuid())
  promptId       String    @map("prompt_id")
  version        Int
  content        String
  commitMessage  String?   @map("commit_message")
  createdAt      DateTime  @default(now()) @map("created_at")
  config         Json      @default("{}")
  defaultModelId String?   @map("default_model_id")
  isPublic       Boolean   @default(false) @map("is_public")
  messages       Json      @default("[]")
  publishedAt    DateTime? @map("published_at")
  variables      Json      @default("[]")
  prompt         Prompt    @relation(fields: [promptId], references: [id], onDelete: Cascade)

  @@unique([promptId, version])
  @@index([promptId])
  @@map("prompt_versions")
}

model Evaluation {
  id              String                @id @default(uuid())
  userId          String                @default("default") @map("user_id")
  name            String
  promptId        String?               @map("prompt_id")
  modelId         String?               @map("model_id")
  judgeModelId    String?               @map("judge_model_id")
  status          EvaluationStatus      @default(pending)
  config          Json                  @default("{}")
  results         Json                  @default("{}")
  createdAt       DateTime              @default(now()) @map("created_at")
  completedAt     DateTime?             @map("completed_at")
  isPublic       Boolean               @default(false) @map("is_public")
  criteria        EvaluationCriterion[]
  runs            EvaluationRun[]
  judgeModel      Model?                @relation("JudgeModel", fields: [judgeModelId], references: [id])
  model           Model?                @relation("EvaluationModel", fields: [modelId], references: [id])
  prompt          Prompt?               @relation(fields: [promptId], references: [id])
  user            User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  testCaseResults TestCaseResult[]
  testCases       TestCase[]

  @@index([userId])
  @@index([promptId])
  @@index([status])
  @@map("evaluations")
}

model TestCase {
  id             String           @id @default(uuid())
  evaluationId   String           @map("evaluation_id")
  name           String           @default("")
  inputText      String           @map("input_text")
  inputVariables Json             @default("{}") @map("input_variables")
  attachments    Json             @default("[]")
  expectedOutput String?          @map("expected_output")
  notes          String?
  orderIndex     Int              @default(0) @map("order_index")
  createdAt      DateTime         @default(now()) @map("created_at")
  results        TestCaseResult[]
  evaluation     Evaluation       @relation(fields: [evaluationId], references: [id], onDelete: Cascade)

  @@index([evaluationId])
  @@index([evaluationId, orderIndex])
  @@map("test_cases")
}

model EvaluationCriterion {
  id           String     @id @default(uuid())
  evaluationId String     @map("evaluation_id")
  name         String
  description  String?
  prompt       String?
  weight       Decimal    @default(1.0) @db.Decimal(5, 2)
  enabled      Boolean    @default(true)
  createdAt    DateTime   @default(now()) @map("created_at")
  evaluation   Evaluation @relation(fields: [evaluationId], references: [id], onDelete: Cascade)

  @@index([evaluationId])
  @@map("evaluation_criteria")
}

model EvaluationRun {
  id                String           @id @default(uuid())
  evaluationId      String           @map("evaluation_id")
  status            EvaluationStatus @default(pending)
  results           Json             @default("{}")
  errorMessage      String?          @map("error_message")
  totalTokensInput  Int              @default(0) @map("total_tokens_input")
  totalTokensOutput Int              @default(0) @map("total_tokens_output")
  modelParameters   Json?            @map("model_parameters")
  startedAt         DateTime         @default(now()) @map("started_at")
  completedAt       DateTime?        @map("completed_at")
  createdAt         DateTime         @default(now()) @map("created_at")
  evaluation        Evaluation       @relation(fields: [evaluationId], references: [id], onDelete: Cascade)
  testCaseResults   TestCaseResult[]

  @@index([evaluationId])
  @@index([status])
  @@index([createdAt(sort: Desc)])
  @@map("evaluation_runs")
}

model TestCaseResult {
  id           String         @id @default(uuid())
  evaluationId String         @map("evaluation_id")
  testCaseId   String         @map("test_case_id")
  runId        String?        @map("run_id")
  modelOutput  String?        @map("model_output")
  scores       Json           @default("{}")
  aiFeedback   Json           @default("{}") @map("ai_feedback")
  latencyMs    Int            @default(0) @map("latency_ms")
  tokensInput  Int            @default(0) @map("tokens_input")
  tokensOutput Int            @default(0) @map("tokens_output")
  passed       Boolean        @default(false)
  errorMessage String?        @map("error_message")
  createdAt    DateTime       @default(now()) @map("created_at")
  evaluation   Evaluation     @relation(fields: [evaluationId], references: [id], onDelete: Cascade)
  run          EvaluationRun? @relation(fields: [runId], references: [id], onDelete: Cascade)
  testCase     TestCase       @relation(fields: [testCaseId], references: [id], onDelete: Cascade)

  @@index([evaluationId])
  @@index([testCaseId])
  @@index([runId])
  @@map("test_case_results")
}

model User {
  id            String       @id @default(uuid())
  email         String       @unique
  passwordHash  String?      @map("password_hash")
  name          String?
  avatar        String?
  status        UserStatus   @default(active)
  emailVerified Boolean      @default(false) @map("email_verified")
  createdAt     DateTime     @default(now()) @map("created_at")
  updatedAt     DateTime     @updatedAt @map("updated_at")
  lastLoginAt   DateTime?    @map("last_login_at")
  evaluations   Evaluation[]
  prompts       Prompt[]
  promptGroups  PromptGroup[]
  providers     Provider[]
  files         StoredFile[]
  ocrSetting    OcrProviderSetting?
  ocrResults    OcrResult[]
  sessions      Session[]
  oauthAccounts OAuthAccount[]
  traces        Trace[]
  roles         UserRole[]

  @@index([email])
  @@index([status])
  @@map("users")
}

model EmailVerification {
  id        String                @id @default(uuid())
  email     String
  codeHash  String                @map("code_hash")
  type      EmailVerificationType
  expiresAt DateTime              @map("expires_at")
  verified  Boolean               @default(false)
  attempts  Int                   @default(0)
  createdAt DateTime              @default(now()) @map("created_at")

  @@index([email, type])
  @@index([expiresAt])
  @@map("email_verifications")
}

model OAuthAccount {
  id                  String        @id @default(uuid())
  userId              String        @map("user_id")
  provider            OAuthProvider
  providerUserId      String        @map("provider_user_id")
  providerEmail       String?       @map("provider_email")
  name                String?
  avatar              String?
  accessTokenEncrypted String?       @map("access_token_encrypted")
  refreshTokenEncrypted String?      @map("refresh_token_encrypted")
  expiresAt           DateTime?      @map("expires_at")
  createdAt           DateTime       @default(now()) @map("created_at")
  updatedAt           DateTime       @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerUserId])
  @@index([userId])
  @@map("oauth_accounts")
}

model Role {
  id          String           @id @default(uuid())
  name        String           @unique
  description String?
  isSystem    Boolean          @default(false) @map("is_system")
  createdAt   DateTime         @default(now()) @map("created_at")
  permissions RolePermission[]
  users       UserRole[]

  @@map("roles")
}

model Permission {
  id          String           @id @default(uuid())
  name        String           @unique
  description String?
  resource    String
  action      String
  createdAt   DateTime         @default(now()) @map("created_at")
  roles       RolePermission[]

  @@unique([resource, action])
  @@index([resource])
  @@map("permissions")
}

model UserRole {
  userId    String   @map("user_id")
  roleId    String   @map("role_id")
  createdAt DateTime @default(now()) @map("created_at")
  role      Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([userId, roleId])
  @@map("user_roles")
}

model RolePermission {
  roleId       String     @map("role_id")
  permissionId String     @map("permission_id")
  createdAt    DateTime   @default(now()) @map("created_at")
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
  @@map("role_permissions")
}

model Session {
  id           String   @id @default(uuid())
  userId       String   @map("user_id")
  refreshToken String   @unique @map("refresh_token")
  userAgent    String?  @map("user_agent")
  ipAddress    String?  @map("ip_address")
  expiresAt    DateTime @map("expires_at")
  createdAt    DateTime @default(now()) @map("created_at")
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@map("sessions")
}

model StoredFile {
  id           String   @id @default(uuid())
  userId       String   @map("user_id")
  originalName String   @map("original_name")
  mimeType     String   @map("mime_type")
  size         Int
  sha256       String
  bucket       String
  objectKey    String   @map("object_key")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  ocrResults   OcrResult[]

  @@index([userId])
  @@index([sha256])
  @@map("files")
}

model OcrProviderSetting {
  userId           String              @id @map("user_id")
  enabled          Boolean             @default(false) @map("ocr_enabled")
  provider         OcrProvider         @default(paddle) @map("selected_provider")
  credentialSource OcrCredentialSource @default(system) @map("credential_source")
  baseUrl          String?             @map("base_url")
  apiKey           String?             @map("api_key_encrypted")
  apiKeyLast4      String?             @map("api_key_last4")
  createdAt        DateTime            @default(now()) @map("created_at")
  updatedAt        DateTime            @updatedAt @map("updated_at")
  user             User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("ocr_provider_settings")
}

model OcrSystemProviderConfig {
  provider    OcrProvider @id
  baseUrl     String?     @map("base_url")
  apiKey      String?     @map("api_key_encrypted")
  apiKeyLast4 String?     @map("api_key_last4")
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")

  @@map("ocr_system_provider_configs")
}

model OcrResult {
  id           String    @id @default(uuid())
  userId       String    @map("user_id")
  fileId       String    @map("file_id")
  provider     OcrProvider
  status       OcrStatus @default(success)
  errorMessage String?   @map("error_message")
  fullText     String    @map("full_text")
  pages        Json?     @map("pages_json")
  createdAt    DateTime  @default(now()) @map("created_at")

  user User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  file StoredFile @relation(fields: [fileId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([fileId])
  @@index([provider])
  @@unique([userId, fileId, provider])
  @@map("ocr_results")
}

model Trace {
  id              String      @id @default(uuid())
  userId          String      @default("default") @map("user_id")
  promptId        String?     @map("prompt_id")
  modelId         String?     @map("model_id")
  input           String
  output          String?
  tokensInput     Int         @default(0) @map("tokens_input")
  tokensOutput    Int         @default(0) @map("tokens_output")
  latencyMs       Int         @default(0) @map("latency_ms")
  status          TraceStatus @default(success)
  errorMessage    String?     @map("error_message")
  metadata        Json        @default("{}")
  attachments     Json?
  thinkingContent String?     @map("thinking_content")
  thinkingTimeMs  Int?        @map("thinking_time_ms")
  createdAt       DateTime    @default(now()) @map("created_at")
  model           Model?      @relation(fields: [modelId], references: [id])
  prompt          Prompt?     @relation(fields: [promptId], references: [id])
  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([promptId])
  @@index([createdAt(sort: Desc)])
  @@map("traces")
}

enum ProviderType {
  openai
  anthropic
  gemini
  custom
  openrouter
}

enum EvaluationStatus {
  pending
  running
  completed
  failed
}

enum TraceStatus {
  success
  error
}

enum UserStatus {
  active
  inactive
  suspended
}

enum EmailVerificationType {
  register
  reset_password
}

enum OAuthProvider {
  google
  linuxdo
}

enum OcrProvider {
  paddle
  paddle_vl
  datalab
}

enum OcrCredentialSource {
  system
  custom
}

enum OcrStatus {
  success
  failed
}
